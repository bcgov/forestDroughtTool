---
title: "Choosing climate data for ASMR calculations"
author: "Hardy Griesbauer"
date: "12/09/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
The purpose of this vignette is to document our process for selecting climate data as input to the asmrCalc() function in the forestDroughtTool R package.

```{r}

# Load libraries
library(bcmaps)
library(weathercan)
library(dplyr)
library(magrittr)
library(ggplot2)

```

## Climate station coverage for BGC units in BC
Environment Canada (EC) daily climate stations seem to be the best so far because they have relatively long records and they record winter precipitation.

We can use a few R packages to identify EC stations with daily data and their corresponding BGC unit.

```{r}

# Step 1.1 - Select stations in BC with daily data and assign to 'stn'
stn<-
  stations %>% 
  filter(prov=="BC" & interval=="day") %>%  
  
# Step 1.2 - Convert to a spatial file and merge with BGC units (this will take awhile!)
  st_as_sf(coords=c("lon","lat")) %>% # convert to spatial file
  st_set_crs(4326) %>% # set to WGS1984 datum
  transform_bc_albers() %>% # set to BC albers projection
  st_join(bec()[,"MAP_LABEL"]) %>%  # merge with BEC
  st_drop_geometry() # drop geometry

# Step 1.3 Summarize station coverage
  stn %>% 
    group_by(MAP_LABEL) %>%
    summarise(Num.Stn=n())

```  

## Subset stations for BGC units of interest
We can now download data for BGC unit(s) of interest.
```{r}
# List the BGC units of interest
bgc<-c("SBSdk","SBSwk1")

# Filter stations for those units
stnBGC<-
  stn %>% 
  filter(MAP_LABEL%in%bgc) %>% # filter for BGC units of interest
  mutate(length=end-start+1) %>% # create a column to show record length
  arrange(desc(length)) %>% 
  select(station_name,station_id,MAP_LABEL,start,end,length)

stnBGC

```

Note there aren't many records for SBSwk1.  Might want to drop the variant from the BGC unit, and see if there any any stations in that subzone but in other variants.

## Downloading of daily climate data
For this vignette, let's download the Smithers A climate station data. From the above table, we see that the station ID is 487.  We'll need this number for the weather download.  We'll also limit the download to 1955 to 1995 (somewhat around the 1961-1990 climate normal period.)

```{r}

# Download climate station data (this can take a long time!)
sm.dat<-
  weather_dl(station_ids=487,start="1955-01-01",end="1995-12-31")

```

You can download data for multiple stations at once.

```{r}



```

## Plot out data for coverage


## Formatting of daily climate data
Daily climate data have to be formatted correctly for the asmrCalc() function to work properly.  There have to seven columns in the data:
- date
- tmn
- tmx
- ppt
- year
- month
- day

As an example, refer to the Prince George daily climate data in the forestDroughtTool package:


```{r, echo=FALSE}
library(forestDroughtTool)
PrinceGeorge
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
